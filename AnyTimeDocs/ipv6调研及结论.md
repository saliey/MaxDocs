

# 参考信息

[站点](https://www.ipv6-cn.com/)
[运营商 IPv6 地址规划设计，讲述可以按二进制位划分是否为 DSL，无线，直连光纤，类似 RFC3531 标准。](https://www.ipv6-cn.com/references/clearcable-IPv6-addressing-case-study.html)
[IPv6 地址规划与分配——全球可路由地址](https://www.ipv6-cn.com/tutorials/ipv6-address-allocation-n-assignment.html)

[ipv6 前缀在 dhcp 的运用](https://datatracker.ietf.org/doc/html/rfc6177)
[IPv6 地址分配给终端站点，建议不要直接以 /48 前缀使用，要更细化。里面并没有讲具体的细化方法。](https://datatracker.ietf.org/doc/html/rfc3633)
[具体位数分配的建议，最左、左右、最中心，是用位数来表示分配的单位。以最右为例：0001，0010，0011 这三个就可以表示为三个楼或家庭](https://www.rfc-editor.org/rfc/rfc3531)

[IPv6技术精要（第2版）概括](https://blog.csdn.net/qq_31220203/article/details/123952180)

[国家标准《IPv6 地址分配和编码规则》](https://max.book118.com/html/2023/0118/8063016134005030.shtm)

IETF RFC 4291　IP Version 6 Addressing Architecture
IETF RFC 8415　Dynamic Host Configuration Protocol for IPv6(DHCPv6)
IETF RFC 7039　Source Address Validation Improvement(SAVI) Framework
IETF RFC 4038  ipv6过度方面的应用
IETF RFC 4193  ipv6唯一单播地址
IETF RFC 4038  是对于 ipv6 内嵌 ipv4 的标准
IETF RFC 8200  ipv6互联网协议第6版


# 结论

1. ipv6 的主机标识是随机生成的，生成算法见下面具体条目
2. 邻居请求，邻居宣告，路由请求，路由宣告，对于确定当前终端的 ipv6 非常重要
3. 如何确定当前设备的 ipv6 ？
    移动网络：无状态分配，终端发出路由请求，等待路由宣告数据，宣告数据会包含 ip 前缀等信息，拿到前缀后自己再随机生成字串并拼接成 ipv6。或者无状态 DHCPv6 分配。
    局域网络：有状态分配，通过 dhcpv6 分配地址；
4. 局域网通讯方法，怎样确定同网段内的其他设备的 mac 和 ipv6 ？
    首先 ipv6 肯定是已知的，因为要通信。
    然后 mac 地址是通过邻居发现协议知道的。这个最终会存在邻居缓存表中。
5. 地址分配层级
    互联网名称与数字地址分配机构（ICANN） -> 五个地区互联网注册管理机构（RIR）（ARIN，RIPE NCC，APNIC）-> CNNIC -> 互联网服务提供商（ISP） -> 个人或企业
6. 协议位数，一条数据的完整报文，解析 ip 数据的方法
    4 8 20 16 8 8 128 128 
7. 随机生成的 ipv6 地址怎样保证唯一性？
    通过 DAD 重复地址检测协议进行查重，主要是看是否有路由宣告的数据返回，有就表明不唯一
8. ip 的分配方法主要是：
    手动：静态配置，mac 地址转换
    自动：DHCP 有状态，SLAAC 无状态
9. ipv6 前缀的具体分配位数;
    前 32 位是给国家/互联网注册机构，到这里就可以确定是哪个运营商了。
    33-48 位，是运营商往下分配给站点、数据中心、中小客户、大中企业的，也就是这里就可以确定到企业单位。
    49-56 位，是运营商分配给家庭、小企业的，也就是到这里可以确定家庭、更小的单位。
    57-64 位，末端设备子网。

    > 同时：
    > 当然上面这个的分配没有标准，是各大运营商按照需求自主分配的，比如还有 32 6 6 6 14 64 这种分配的，分别表示 前缀、省、市、县、子标识、接口标识。
    > 也有把具体位数来当做标识的，比如说从 36 位开始的位符为 1110 则表示为移动网络，1101 表示为直连光纤，1100 表示为 DSL DSLAM。
    > 还有说法是：其中前32位由RIR分配（如亚太互联网络信息中心），32到48位由ISP分配（如中国移动、中国联通），子网ID由站点分配（如Google、Facebook）。

10. 早期在 ipv6 后坠加 ipv4 地址的方法以作为过渡的手段已经废除
11. 位数的划分，可分为字节，半字节
12. 所谓的无状态地址和有状态地址主要的区分是 M 标记和 O 标记。M 是 管理标志，O 是其他配置的标志。
    M 标记置 1 是指当前的 ipv6 地址要使用 dhcpv6 来分配具体地址，此时标识有状态。
    O 标记置 1 是指当前 ipv6 所对应的其他配置信息要使用 dhcpv6 获取，比如 dns 查询走 dhcpv6。
    所正常来讲，要使用无状态 dhcpv6 来分配地址，这样拿到的 ipv6 的接口标识为是指随机串，然后 dns 等也会走 dhcpv6 。
13. ipv6 地址分为前缀、子网标识和接口标识符。
    前缀是运营实体申请到的地址前缀，类比运营商拿到的都一样。
    子网标识是站点内子网的标识符，比如运营商下可以再具体到省市县街道等。
    接口标识是随机串。
14. ipv6 地址中出 ff00::/8 以外的所有地址都是单播地址。
    fe80::/10 的所有地址是本地链路单播地址，就是指局域网 ip。
    fc00::/8 是唯一本地单播地址，主要用于物联网。
15. 几个前缀的说明：
240e
Chinatelecom
2402
Tsinghua University
2409  
China Mobile
2408
China Unicom
16. 


# 1 相关术语

## 1

术语 | 解释和示例
--- | ---
静态分配 | 在网络中，为设备手动分配的固定IPv6地址。想象这就像你的房子的地址，不论什么时候你都知道回家的地址是不变的。
动态分配（如 DHCPv6） | 网络管理员可以自动地为设备分配IPv6地址。这就像一个酒店服务，你每次来的时候，都可能被分配到不同的房间。
无状态地址自动配置 (SLAAC) | 设备自行生成IPv6地址的方法。就像自己给自己找一个席位，而不需要等待主人指派。
随机数生成 | 用于产生随机数，如在生成IPv6地址的过程中。这就像每次掷骰子，你不知道下一次结果会是多少。
随机数测试 | 用于检验生成的随机数的质量，以确保其随机性。就像检验掷出的骰子是否被操控了。
地址再生 | 用于更改设备的IPv6地址的过程。就像换个新家，新的地址。
嗅探协议 | 协议用于监控网络中的数据包。就像一只警犬在机场嗅探行李。
邻居发现 | 一种在同一网络内找出其他设备的过程。就像在新邻居搬来时去敲门问好。
有状态地址自动配置 | 设备从服务器获取IPv6地址的方法。这就像在一次聚会上由主人指定你的座位。
手动配置 | 手动给设备分配IPv6地址。就像你自己选择一个座位然后坐下。
移动网络网关（MNG） | 在移动网络中，连接设备与外部网络的设备。就像一个门将，他决定谁可以进入足球场。
分组数据网络（PDN） | 用于传输数据包的网络。就像高速公路，汽车（数据包）在上面行驶。
移动节点（MN） | 在移动网络中，一个移动的设备。就像一个旅行者在各地漫游。
重复地址检测（DAD） | 一个在网络中检查IPv6地址是否被重复使用的过程。就像检查是否有两个人使用同一个电话号码。
邻居不可达性检测（NUD） | 用于检查网络中的设备是否可以连接的过程。就像你打电话给朋友，看他是否在接听。
MAC地址解析 | 将网络层地址（如IPv6地址）转换为物理层地址（如MAC地址）的过程。就像你知道朋友的名字，但你需要查找他的电话号码。
蜂窝互联网 | 使用蜂窝技术的互联网连接。就像你的手机上网，使用的是移动运营商的网络。
IMS 网络 | IP多媒体子系统，用于在蜂窝网络中提供音频和视频服务。就像通过手机网络打电话或看视频。
多播寻址 | 一种发送消息给多个接收者的方法。就像广播电台，一次发射，多人收听。
任播寻址 | 一种发送消息给任意一个接收者的方法。就像一个公司的客服热线，无论谁打电话，只有一个客服会接听。
移动IPv6 | 移动设备在移动时保持IPv6连接的技术。就像你在打电话时可以随时移动，但通话仍在继续。
路由器宣告消息 | 路由器向网络广播其存在和配置的消息。就像一个新来的班主任向学生介绍自己。
分类地址 | 使用网络号和主机号来区分IPv6地址的方法。就像用街道和房号来描述一个地址。
划分子网 | 将一个大的网络分成几个小的网络。就像一个大的公寓楼被分为几个小的单元。
无分类编址（CIDR） | 一种灵活地分配IPv6地址的方法，不用固定的网络号和主机号。就像邮编系统，它可以覆盖不同大小的地区。
邻居缓存表 | 存储网络中设备信息的表。就像你的电话本，存储你朋友的电话号码。
目的地缓存表 | 存储数据包应该如何到达目的地的信息。就像导航系统，它知道如何到达目的地。
路由聚合 | 一种将多个路由合并为一个的方法。就像一个大的购物中心，你可以在一个地方完成所有的购物。
链路本地地址 | 在同一个网络链路中有效的IPv6地址。就像你家的内部电话，只有家里的人可以使用。
唯一本地地址 | 在一个局部网络中独一无二的IPv6地址。就像你的邮箱地址，只在你的公寓楼内有效。
内嵌 IPv4 的地址 | 包含一个IPv4地址的IPv6地址。就像邮寄一个包裹，在包裹的地址中还有一个小的包裹的地址。
路由器请求（RS）消息 | 设备请求路由器信息的消息。就像一个新生在寻找班主任。
路由器宣告（RA）消息 | 路由器回应请求信息的消息。就像班主任向新生介绍自己。
邻居请求（NS）消息 | 设备请求其他设备信息的消息。就像你向一个陌生人介绍自己。
邻居宣告（NA）消息 | 设备回应请求信息的消息。就像那个陌生人回应你的介绍。
重定向消息 | 一种改变数据包路径的消息。就像导航系统告诉你重新规划路线。
PI (Provider Independent) 地址 | 这些地址是直接分配给终端用户的，并且不依赖于任何特定的网络服务提供商。
PA (Provider Aggregatable) 地址 | 这些地址是由网络服务提供商分配给其客户的，并且一般在用户更换服务提供商时无法携带。
EBGP (外部边界网关协议，或 External Border Gateway Protocol) | 是一个在自治系统 (AS) 之间用于路由交换的协议。
AS号 | 即自治系统号，是用于识别特定网络实体（如互联网服务提供商，大型企业或政府机构等）的唯一编号。这些编号在全球范围内是唯一的，并由互联网号码分配机构（例如互联网分配数字机构或区域互联网注册机构）分配。自治系统使用这些编号与其他网络进行互联和交互。也就是 相同的系统号下面可以用 EBGP 协议进行通信。
loopback地址（或称为回环地址） | 是一种特殊的IP地址，主要用于网络设备（如路由器或服务器）自我测试和通信。就是说本地地址，类似 localhost。
valid lifetime | 是指 ipv6 的有效期，正常观察到终端的设置都是 forever
preferred lietime | 是指已经建立连接的有效期，也就是如果已经建立连接，那这个 ipv6 还能正常接受和发送数据；（那系统内这样识别的呢）新建立的连接将不再使用这个地址。
接口标识（Interface Identifiers） | 在 IPv6 中，接口标识并不是网络接口的名称，而是用来唯一标识网络接口的一部分 IPv6 地址
网络前缀（Network Prefixes） | 网络前缀是 IPv6 地址的一部分，它标识了设备所在的网络。


## 2

| 术语                     | 解释                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 静态分配                 | 静态分配是手动将特定的 IP 地址分配给特定的设备，这个地址是不会自动改变的。例如，你有一台打印机，你希望每次打印时，都能通过同一个 IP 地址找到它，你就可以为它静态分配一个 IP 地址。                                                                                                                                                                                                                |
| 动态分配（如 DHCPv6）    | 动态分配是通过 DHCP（动态主机配置协议）自动分配 IP 地址的过程。设备在需要网络连接时请求 IP 地址，DHCPv6 服务器会从 IP 地址池中选择一个分配给设备，并决定这个 IP 地址的租期。例如，你的笔记本电脑可能每次连接到网络时，都会从 DHCPv6 服务器获取一个 IP 地址，这个地址在你断开连接时会被回收，并可能在下次连接时被分配给其他设备。                                                                                                      |
| 无状态地址自动配置 (SLAAC) | SLAAC（StateLess Address AutoConfiguration）是一种无需 DHCP 服务器即可自动配置 IPv6 地址的方法。设备将其网络接口的 MAC 地址转换为 IPv6 地址的一部分，并加上路由器通告的网络前缀，生成一个唯一的 IPv6 地址。例如，设备的 MAC 地址是 00-00-5E-00-53-01，路由器的网络前缀是 2001:0db8:85a3::/64，那么设备的 IPv6 地址可以是 2001:0db8:85a3::200:5eff:fe00:5301。                                                                                                   |
| 随机数生成                 | 随机数生成是计算机算法生成看似无规律的数字的过程。例如，生成加密密钥时就需要随机数。在 IPv6 中，也可用于生成临时地址以增强安全性和隐私性。                                                                                                                                                                                                                                                                 |
| 随机数测试                 | 随机数测试是验证生成的随机数是否真的随机的方法。在加密和网络安全中非常重要，因为如果随机数生成器有规律可循，那么攻击者可能会猜到生成的密钥，破解加密。                                                                                                                                                                                                                                                                           |
| 地址再生                 | 地址再生是 IPv6 中一种提高安全性和隐私性的方式，通过定期更换设备的 IPv6 地址，让追踪设备的行为变得困难。例如，设备可能每隔几小时就使用一个全新的随机 IPv6 地址连接到网络。                                                                                                                                                                                                                                                                |
| 嗅探协议                 | 嗅探协议通常用于网络

设备收集网络流量信息。例如，设备可以使用嗅探协议监听网络上的数据包，以收集有关网络活动的信息。在 IPv6 网络中，嗅探协议可以用来监听邻居发现消息，获得其他设备的 IPv6 地址。                                                                                                                                                                                                                                              |
| 邻居发现                 | 邻居发现是 IPv6 中的一种协议，用于自动发现同一网络上的其他设备，并获取它们的 IP 地址。设备通过发送邻居请求消息，等待其他设备的邻居宣告消息来实现这一点。例如，设备 A 想知道设备 B 的 IPv6 地址，设备 A 会发送一个邻居请求消息，设备 B 收到后会回复一个邻居宣告消息，告诉设备 A 它的 IPv6 地址。                                                                                                                                                                                  |
| 有状态地址自动配置         | 有状态地址自动配置是通过 DHCPv6 实现的一种自动配置 IPv6 地址的方法。在有状态配置中，DHCPv6 服务器负责跟踪哪些 IP 地址已经分配出去，以及分配给了哪些设备，因此叫做“有状态”。与此对应的是无状态地址自动配置（SLAAC），其中设备自行生成 IPv6 地址，不需要 DHCPv6 服务器进行跟踪。                                                                                                                                                                                                         |
| 手动配置                 | 手动配置是网络管理员手动为设备分配 IP 地址的过程。这种方式在需要固定 IP 地址的场景中常见，如服务器或打印机。例如，你可以手动将 IP 地址 2001:0db8:85a3::8a2e:0370:7334 配置给一台服务器。                                                                                                                                                                                                                                                 |
| 移动网络网关（MNG）        | 移动网络网关是一个网络节点，可以在用户设备移动时保持网络连接不断。例如，当你的手机从一个 WiFi 网络切换到另一个 WiFi 网络时，移动网络网关能确保你的网络通信不被打断。在 IPv6 中，移动网络网关可以使用移动 IPv6 协议来实现这一功能。                                                                                                                                                                                                                              |
| 分组数据网络（PDN）        | 分组数据网络是一种用于传输数据包的网络，如互联网。在 PDN 中，数据被切割成多个小包，每个小包独立地在网络中传输，最后在接收端被重新组合成完整的数据。例如，当你通过互联网看视频时，视频数据会被切割成多个数据包，通过 PDN 发送到你的设备，然后你的设备把这些数据包重新组合成完整的视频。                                                                                                                                                                              |


# 2 接口标识字串随机生成方法

1. 获取当前的时间（64位时间值，精确到十纳秒）。
2. 获取一个随机或伪随机值（64位）。
3. 获取某些可用的 EUI-64 格式的网络接口地址。
4. 将上述三个值连接在一起，形成一个192位的值。
5. 对这个192位的值使用 SHA-1 哈希算法，生成一个160位的哈希值。
6. 取这个哈希值的前40位作为全局 ID。

同时还有国家标注是讲：IID=E(联网终端标识，前缀，随机数，保留项，鉴别码，KEY)


# 3 协议字节示例

```
        0x0000:  6c00 0000 0040 3aff fe80 0000 0000 0000
        0x0010:  7ec3 85ff fecc 79f1 ff02 0000 0000 0000
        0x0020:  0000 0000 0000 0001 8600 4550 40c0 0708
        0x0030:  0000 0000 0000 0000 0101 7cc3 85cc 79f1
        0x0040:  0501 0000 0000 05dc 0304 40c0 0027 8d00
        0x0050:  0009 3a80 0000 0000 fdbd 0ff1 ce00 01e2
        0x0060:  0000 0000 0000 0000
```
该数据报首部“版本”字段为6（0x6），“通信量类”字段为192（0xc0），“流标号”字段为0x00000，“有效载荷长度”字段为64（0x0040），“下一个首部”字段为58（0x3a），58表示其上层协议为ICMPv6，“跳数限制”字段为255（0xff），“源地址”为fe80::7ec3:85ff:fecc:79f1，“目的地址”为ff02::1。


```
        0x0000:  6001 0600 0014 0640 fdbd 0ff1 ce00 01e2
        0x0010:  18ff 2705 09ad 1a0e 2606 50c0 8003 0000
        0x0020:  0000 0000 0000 0153 d50f 01bb ce7f 206f
        0x0030:  3600 9e2a 5010 0800 d482 0000
```

该数据报首部“版本”字段为6（0x6），“通信量类”字段为0（0x00），“流标号”字段为0x10600，“有效载荷长度”字段为20（0x0014），“下一个首部”字段为6（0x06），6表示其上层协议为TCP，“跳数限制”字段为64（0x40），“源地址”为fdbd:ff1:ce00:1e2:18ff:2705:9ad:1a0e，“目的地址”为2606:50c0:8003::153。


# 4 设备内查看 ipv6

```
HWANA:/ $ ip -6 addr show
8: rmnet0: <NOARP,UP,LOWER_UP> mtu 1400 state UNKNOWN qlen 1000
    inet6 2408:84e1:230:8c:9d1a:7359:71a7:643d/64 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::5a02:3ff:fe04:506/64 scope link
       valid_lft forever preferred_lft forever
```

这个输出提供了关于`rmnet0`网络接口的IPv6地址的信息。

1. `inet6 2408:84e1:230:8c:9d1a:7359:71a7:643d/64 scope global`：这一行表示该接口拥有一个全球范围（global）的IPv6地址`2408:84e1:230:8c:9d1a:7359:71a7:643d`。`/64`表示该地址的网络前缀长度是64位。

2. `valid_lft forever preferred_lft forever`：这一行表示这个IPv6地址的有效生命周期（valid_lft）和首选生命周期（preferred_lft）都设置为"forever"，也就是无限。这表示这个地址是永久的，不会过期。

3. `inet6 fe80::5a02:3ff:fe04:506/64 scope link`：这一行表示该接口拥有一个链路本地（link-local）的IPv6地址`fe80::5a02:3ff:fe04:506`。链路本地地址只在同一网络链路中的设备之间有效，通常用于网络设备的自动配置和通信。

4. `valid_lft forever preferred_lft forever`：这一行同样表示这个链路本地地址的有效生命周期和首选生命周期都设置为"forever"，也就是无限。

综上，这个接口的两个IPv6地址（一个全球地址，一个链路本地地址）都是永久的，不会过期。


# 5 地址分配

2001:0200::/23 分配给 APNIC，分配日期为 1999-07-01
2001:0400::/23 分配给 ARIN，分配日期为 1999-07-01
2001:0600::/23 分配给 RIPE NCC，分配日期为 1999-07-01
2001:0c00::/23 分配给 APNIC，分配日期为 2002-05-02
2600:0000::/12 分配给 ARIN，分配日期为 2006-10-03
2400:0000::/12 分配给 APNIC，分配日期为 2006-10-03










